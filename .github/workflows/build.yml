name: Build Mongoose + mbedTLS 3.6.5 (MinGW GCC 9.3 SJLJ, TLS 1.3)

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: i686
            file: winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            prefix: mingw32
          - arch: x86_64
            file: winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            prefix: mingw64

    steps:
    - uses: actions/checkout@v4

    # 1. 安装 7-Zip
    - name: Setup 7-Zip
      run: |
        choco install 7zip -y
        "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Append

    # 2. 下载并配置 MinGW GCC 9.3 SJLJ
    - name: Install MinGW
      shell: pwsh
      run: |
        $url = "https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/${{ matrix.file }}"
        $archive = "D:\mingw.7z"
        $dest = "C:\mingw\${{ matrix.prefix }}"
        
        # 下载（带重试）
        $attempt = 0
        do {
          $attempt++
          Write-Host "Downloading MinGW (attempt $attempt)..."
          curl.exe -L -o $archive $url --fail --silent --show-error --max-time 180
          if (Test-Path $archive) { break }
          Start-Sleep -Seconds 10
        } while ($attempt -lt 3)
        
        if (-not (Test-Path $archive)) { throw "Failed to download MinGW" }
        
        # 解压
        & "C:\Program Files\7-Zip\7z.exe" x $archive -o"$dest" -y
        
        # 设置 PATH
        "$dest\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        Write-Host "MinGW installed successfully"

    # 3. 验证工具链
    - name: Verify Toolchain
      shell: pwsh
      run: |
        gcc --version
        g++ --version
        mingw32-make --version
        cmake --version

    # 4. 下载 Mongoose 源码
    - name: Get Mongoose
      shell: pwsh
      run: |
        git clone --depth 1 --branch master https://github.com/cesanta/mongoose.git mongoose-src

    # 5. 下载 mbedTLS 3.6.5
    - name: Get mbedTLS 3.6.5
      shell: pwsh
      run: |
        $url = "https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/v3.6.5.zip"
        $zip = "D:\mbedtls.zip"
        
        curl.exe -L -o $zip $url --fail --silent --show-error --max-time 120
        Expand-Archive -Path $zip -DestinationPath "C:\" -Force
        Rename-Item -Path "C:\mbedtls-3.6.5" -NewName "C:\mbedtls-src" -Force

    # 6. 构建并安装 mbedTLS (关键修复：使用 make install)
    - name: Build and Install mbedTLS
      shell: pwsh
      run: |
        cd C:\mbedtls-src
        
        # 清理旧的构建
        Remove-Item -Recurse -Force -ErrorAction SilentlyContinue build, C:\mbedtls-install
        New-Item -ItemType Directory -Force -Path build
        
        # 配置（指定安装前缀）
        cmake -G "MinGW Makefiles" -S . -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_C_COMPILER=gcc `
          -DCMAKE_INSTALL_PREFIX="C:\mbedtls-install" `
          -DENABLE_TESTING=OFF `
          -DENABLE_PROGRAMS=OFF `
          -DGEN_FILES=OFF
        
        # 构建
        cmake --build build --parallel 4
        
        # 安装到 C:\mbedtls-install（修复：使用标准安装路径）
        cmake --install build
        
        # 验证安装
        if (-not (Test-Path "C:\mbedtls-install\lib\libmbedcrypto.a")) {
          throw "mbedTLS installation failed - libraries not found"
        }
        
        Write-Host "✅ mbedTLS 3.6.5 installed successfully"
        Get-ChildItem "C:\mbedtls-install\lib\*.a"

    # 7. 构建 Mongoose 静态库
    - name: Build Mongoose
      shell: pwsh
      run: |
        $buildDir = "mongoose-src/build-${{ matrix.arch }}"
        New-Item -ItemType Directory -Force -Path $buildDir
        cd $buildDir
        
        # 编译参数
        $cflags = @(
          "-O3"
          "-DMG_ENABLE_IPV6=1"
          "-DMG_ENABLE_LINES=1"
          "-DMG_TLS=MG_TLS_MBED"
          "-DNDEBUG"
          "-Wall"
          "-static"
          "-I.."
          "-IC:\mbedtls-install\include"
        )
        
        # 编译 mongoose.c
        gcc -c ($cflags -join " ") ..\mongoose.c -o mongoose.o
        if ($LASTEXITCODE -ne 0) { throw "Mongoose compilation failed" }
        
        # 打包静态库
        ar rcs libmongoose.a mongoose.o
        ranlib libmongoose.a
        
        Write-Host "✅ Mongoose library built"
        Get-Item libmongoose.a

    # 8. 测试链接（验证所有库可正常链接）
    - name: Test Linking
      shell: pwsh
      run: |
        cd mongoose-src/build-${{ matrix.arch }}
        
        # 创建测试程序
        @'
        #include "mongoose.h"
        #include <stdio.h>
        int main(void) { 
          struct mg_mgr mgr;
          mg_mgr_init(&mgr);
          printf("Mongoose %s + mbedTLS 3.6.5 (TLS 1.3) OK\n", MG_VERSION); 
          mg_mgr_free(&mgr);
          return 0; 
        }
        '@ | Set-Content "test.c" -Encoding ASCII
        
        # 链接（严格按照顺序：mongoose -> mbedtls -> mbedx509 -> mbedcrypto -> winsock)
        gcc -static test.c `
          -I.. -IC:\mbedtls-install\include `
          -L. -lmongoose `
          -LC:\mbedtls-install\lib -lmbedtls -lmbedx509 -lmbedcrypto `
          -lws2_32 -lwsock32 -lbcrypt `
          -o test.exe
        
        if (-not (Test-Path "test.exe")) { throw "Linking failed" }
        
        Write-Host "✅ Linking successful"
        & ".\test.exe"

    # 9. 打包成品
    - name: Package
      shell: pwsh
      run: |
        $pkg = "mongoose-mbedtls365-gcc93-sjlj-${{ matrix.arch }}"
        New-Item -ItemType Directory -Path "$pkg/lib", "$pkg/include/mbedtls", "$pkg/include/psa" -Force
        
        # 复制 Mongoose
        Copy-Item "mongoose-src/build-${{ matrix.arch }}/libmongoose.a" "$pkg/lib/"
        Copy-Item "mongoose-src/mongoose.h" "$pkg/include/"
        
        # 复制 mbedTLS（从安装目录）
        Copy-Item "C:\mbedtls-install/lib/*.a" "$pkg/lib/"
        Copy-Item "C:\mbedtls-install/include/mbedtls/*.h" "$pkg/include/mbedtls/"
        Copy-Item "C:\mbedtls-install/include/psa/*.h" "$pkg/include/psa/" -ErrorAction SilentlyContinue
        
        # 使用说明
        @"
        Mongoose + mbedTLS 3.6.5 (TLS 1.3)
        Architecture: ${{ matrix.arch }}
        Compiler: MinGW GCC 9.3 SJLJ
        
        Linking Order (Important):
        gcc your_app.c -I./include -L./lib ^
          -lmongoose -lmbedtls -lmbedx509 -lmbedcrypto ^
          -lws2_32 -lbcrypt -static
        
        Features:
        - TLS 1.3 (default) + TLS 1.2 support
        - SJLJ exception handling
        - Static linking (no DLL dependencies)
        "@ | Out-File -Encoding UTF8 "$pkg/README.txt"
        
        # 创建 CMake config
        @"
        add_library(mbedcrypto STATIC IMPORTED)
        set_target_properties(mbedcrypto PROPERTIES IMPORTED_LOCATION "`${CMAKE_CURRENT_LIST_DIR}/lib/libmbedcrypto.a")
        
        add_library(mbedx509 STATIC IMPORTED)
        set_target_properties(mbedx509 PROPERTIES IMPORTED_LOCATION "`${CMAKE_CURRENT_LIST_DIR}/lib/libmbedx509.a")
        target_link_libraries(mbedx509 INTERFACE mbedcrypto)
        
        add_library(mbedtls STATIC IMPORTED)
        set_target_properties(mbedtls PROPERTIES IMPORTED_LOCATION "`${CMAKE_CURRENT_LIST_DIR}/lib/libmbedtls.a")
        target_link_libraries(mbedtls INTERFACE mbedx509)
        
        add_library(mongoose STATIC IMPORTED GLOBAL)
        set_target_properties(mongoose PROPERTIES
          IMPORTED_LOCATION "`${CMAKE_CURRENT_LIST_DIR}/lib/libmongoose.a"
          INTERFACE_INCLUDE_DIRECTORIES "`${CMAKE_CURRENT_LIST_DIR}/include"
          INTERFACE_COMPILE_DEFINITIONS "MG_TLS=MG_TLS_MBED;MG_ENABLE_IPV6=1"
          INTERFACE_LINK_LIBRARIES "mbedtls;ws2_32;bcrypt"
        )
        "@ | Out-File -Encoding UTF8 "$pkg/mongoose-config.cmake"
        
        # 压缩
        Compress-Archive -Path $pkg -DestinationPath "$pkg.zip" -Force
        
        # 重命名为标准名称供上传使用
        Rename-Item "$pkg.zip" "mongoose-mbedtls365-${{ matrix.arch }}.zip"

    # 10. 上传产物
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mongoose-mbedtls365-${{ matrix.arch }}
        path: mongoose-src/build-${{ matrix.arch }}/mongoose-mbedtls365-*.zip
        if-no-files-found: error

  # 创建 Release（仅在打 tag 时执行）
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          mongoose-mbedtls365-i686/*.zip
          mongoose-mbedtls365-x86_64/*.zip
        name: Mongoose + mbedTLS 3.6.5 (MinGW GCC 9.3 SJLJ) ${{ github.ref_name }}
        body: |
          ## Mongoose + mbedTLS 3.6.5 LTS (TLS 1.3 Enabled)
          
          ### Build Info
          - **Compiler**: MinGW-w64 GCC 9.3.0 (SJLJ exception handling)
          - **Architectures**: i686 (32-bit), x86_64 (64-bit)
          - **mbedTLS**: 3.6.5 LTS (TLS 1.3 support by default)
          - **Mongoose**: Latest master branch
          
          ### Package Contents
          - `libmongoose.a` - Mongoose library with mbedTLS backend
          - `libmbedtls.a`, `libmbedx509.a`, `libmbedcrypto.a` - mbedTLS libraries
          - `mongoose.h`, `mbedtls/*.h`, `psa/*.h` - Headers
          - `mongoose-config.cmake` - CMake integration
          
          ### Usage
          ```bash
          gcc your_app.c -I./include -L./lib \
            -lmongoose -lmbedtls -lmbedx509 -lmbedcrypto \
            -lws2_32 -lbcrypt -static
          ```
          
          **Note**: Use `-static` to avoid dependency on `libgcc_s_sjlj-1.dll`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
