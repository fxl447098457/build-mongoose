name: Build Mongoose for Windows (sjlj, GCC 9.3)

on: [push, workflow_dispatch]

jobs:
  build-windows:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        arch: [i686, x86_64]
        build_type: [static, shared]
    steps:
      - name: Checkout Mongoose
        uses: actions/checkout@v4
        with:
          repository: cesanta/mongoose
          ref: 7.20

      # === 下载 WinLibs 的 GCC 9.3 sjlj 独立包（Linux 版）===
      - name: Set toolchain URL
        id: toolchain
        run: |
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            echo "URL=https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-14.0.0-10.0.0-msvcrt-r3/winlibs-x86_64-posix-sjlj-gcc-9.3.0-mingw-w64-7.0.0-r3.tar.xz" >> $GITHUB_OUTPUT
            echo "PREFIX=x86_64-w64-mingw32" >> $GITHUB_OUTPUT
          else
            echo "URL=https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-14.0.0-10.0.0-msvcrt-r3/winlibs-i686-posix-sjlj-gcc-9.3.0-mingw-w64-7.0.0-r3.tar.xz" >> $GITHUB_OUTPUT
            echo "PREFIX=i686-w64-mingw32" >> $GITHUB_OUTPUT
          fi

      - name: Download and extract toolchain
        run: |
          wget -O mingw.tar.xz "${{ steps.toolchain.outputs.URL }}"
          mkdir -p mingw
          tar -xf mingw.tar.xz -C mingw --strip-components=1
          echo "$(pwd)/mingw/bin" >> $GITHUB_PATH

      - name: Verify GCC version and exception model
        run: |
          gcc --version
          # Check if sjlj is used (look for __sjlj__ in preprocessor)
          echo | gcc -dM -E - | grep -i sjlj || echo "sjlj not detected in macros (normal)"

      - name: Checkout mbedTLS
        uses: actions/checkout@v4
        with:
          repository: Mbed-TLS/mbedtls
          ref: v3.6.5
          path: mbedtls
          submodules: recursive

      - name: Build mbedTLS
        run: |
          mkdir -p mbedtls/build && cd mbedtls/build
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_BUILD_TYPE=Release
          make -j2

      - name: Create CMakeLists.txt for Mongoose
        run: |
          cat > CMakeLists.txt << 'EOF'
          cmake_minimum_required(VERSION 3.10)
          project(mongoose LANGUAGES C)
          add_library(mongoose mongoose.c)
          target_include_directories(mongoose PUBLIC .)
          if(ENABLE_TLS)
            target_include_directories(mongoose PRIVATE ${MBEDTLS_INCLUDE_DIR})
            target_link_libraries(mongoose 
              ${MBEDTLS_LIBRARY}
              ${MBEDX509_LIBRARY}
              ${MBEDCRYPTO_LIBRARY}
            )
            target_compile_definitions(mongoose PRIVATE MG_ENABLE_MBEDTLS=1)
          endif()
          if(BUILD_SHARED_LIBS)
            set_target_properties(mongoose PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS ON)
          endif()
          EOF

      - name: Build Mongoose
        env:
          MBEDTLS_INCLUDE_DIR: ${{ github.workspace }}/mbedtls/include
          MBEDTLS_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedtls.a
          MBEDX509_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedx509.a
          MBEDCRYPTO_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedcrypto.a
        run: |
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=${{ matrix.build_type == 'shared' && 'ON' || 'OFF' }} \
            -DENABLE_TLS=ON \
            -DMBEDTLS_INCLUDE_DIR="$MBEDTLS_INCLUDE_DIR" \
            -DMBEDTLS_LIBRARY="$MBEDTLS_LIBRARY" \
            -DMBEDX509_LIBRARY="$MBEDX509_LIBRARY" \
            -DMBEDCRYPTO_LIBRARY="$MBEDCRYPTO_LIBRARY"
          cmake --build .

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cd build
          if [[ "${{ matrix.build_type }}" == "shared" ]]; then
            cp libmongoose.dll.a ../artifacts/ 2>/dev/null || true
            cp mongoose.dll ../artifacts/ 2>/dev/null || true
          else
            cp libmongoose.a ../artifacts/ 2>/dev/null || true
          fi
          cp ../mongoose.h ../artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongoose-${{ matrix.arch }}-${{ matrix.build_type }}-gcc93-sjlj-tls
          path: artifacts/
