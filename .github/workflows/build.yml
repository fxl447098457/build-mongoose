name: Build Mongoose for Windows (Linux Cross-Compile)

on: [push, workflow_dispatch]

jobs:
  build-windows:
    runs-on: ubuntu-20.04  # 唯一提供 GCC 9.3 的官方 Ubuntu
    strategy:
      matrix:
        arch: [i686, x86_64]
        build_type: [static, shared]
    steps:
      - name: Checkout Mongoose
        uses: actions/checkout@v4
        with:
          repository: cesanta/mongoose
          ref: 7.20

      - name: Install MinGW-w64 cross compiler (GCC 9.3)
        run: |
          sudo apt update
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            sudo apt install -y gcc-mingw-w64-x86-64=9.3-win32-seh-1
            echo "CC=x86_64-w64-mingw32-gcc" >> $GITHUB_ENV
            echo "AR=x86_64-w64-mingw32-ar" >> $GITHUB_ENV
            echo "STRIP=x86_64-w64-mingw32-strip" >> $GITHUB_ENV
          else
            sudo apt install -y gcc-mingw-w64-i686=9.3-win32-sjlj-1
            echo "CC=i686-w64-mingw32-gcc" >> $GITHUB_ENV
            echo "AR=i686-w64-mingw32-ar" >> $GITHUB_ENV
            echo "STRIP=i686-w64-mingw32-strip" >> $GITHUB_ENV
          fi

      - name: Verify GCC version
        run: |
          $CC --version

      - name: Checkout mbedTLS
        uses: actions/checkout@v4
        with:
          repository: Mbed-TLS/mbedtls
          ref: v3.6.5
          path: mbedtls
          submodules: recursive

      - name: Build mbedTLS (cross-compile)
        run: |
          mkdir -p mbedtls/build && cd mbedtls/build
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=$CC \
            -DCMAKE_AR=$AR \
            -DCMAKE_BUILD_TYPE=Release
          make -j2

      - name: Create CMakeLists.txt for Mongoose
        run: |
          cat > CMakeLists.txt << EOF
          cmake_minimum_required(VERSION 3.10)
          project(mongoose LANGUAGES C)
          add_library(mongoose mongoose.c)
          target_include_directories(mongoose PUBLIC .)
          if(ENABLE_TLS)
            target_include_directories(mongoose PRIVATE ${MBEDTLS_INCLUDE_DIR})
            target_link_libraries(mongoose 
              ${MBEDTLS_LIBRARY}
              ${MBEDX509_LIBRARY}
              ${MBEDCRYPTO_LIBRARY}
            )
            target_compile_definitions(mongoose PRIVATE MG_ENABLE_MBEDTLS=1)
          endif()
          if(BUILD_SHARED_LIBS)
            set_target_properties(mongoose PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS ON)
          endif()
          EOF

      - name: Build Mongoose
        env:
          MBEDTLS_INCLUDE_DIR: ${{ github.workspace }}/mbedtls/include
          MBEDTLS_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedtls.a
          MBEDX509_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedx509.a
          MBEDCRYPTO_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedcrypto.a
        run: |
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Windows \
            -DCMAKE_C_COMPILER=$CC \
            -DCMAKE_AR=$AR \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=${{ matrix.build_type == 'shared' && 'ON' || 'OFF' }} \
            -DENABLE_TLS=ON \
            -DMBEDTLS_INCLUDE_DIR="$MBEDTLS_INCLUDE_DIR" \
            -DMBEDTLS_LIBRARY="$MBEDTLS_LIBRARY" \
            -DMBEDX509_LIBRARY="$MBEDX509_LIBRARY" \
            -DMBEDCRYPTO_LIBRARY="$MBEDCRYPTO_LIBRARY"
          cmake --build .

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cd build
          if [[ "${{ matrix.build_type }}" == "shared" ]]; then
            cp libmongoose.dll.a ../artifacts/ 2>/dev/null || true
            cp mongoose.dll ../artifacts/ 2>/dev/null || true
            $STRIP ../artifacts/mongoose.dll 2>/dev/null || true
          else
            cp libmongoose.a ../artifacts/ 2>/dev/null || true
          fi
          cp ../mongoose.h ../artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongoose-${{ matrix.arch }}-${{ matrix.build_type }}-gcc93-tls
          path: artifacts/
