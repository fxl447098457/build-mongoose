name: Build Mongoose + mbedTLS 3.6.5 (MinGW GCC 9.3 SJLJ, TLS 1.3)

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019  # windows-2019 更稳定，且预装更多工具
    strategy:
      fail-fast: false  # 一个架构失败不影响另一个
      matrix:
        include:
          - arch: i686
            file: winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            prefix: mingw32
          - arch: x86_64
            file: winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            prefix: mingw64

    steps:
    - uses: actions/checkout@v4
    
    # 1. 下载 Mongoose (使用 GitHub CLI 更稳定)
    - name: Get Mongoose source
      run: |
        git clone --depth 1 https://github.com/cesanta/mongoose.git mongoose-src

    # 2. 安装 7-Zip (确保可用)
    - name: Install 7-Zip
      run: |
        choco install 7zip -y
        "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Append

    # 3. 下载并解压 MinGW (使用 curl + 7z，带重试逻辑)
    - name: Install MinGW GCC 9.3
      shell: pwsh
      run: |
        $mingwUrl = "https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/${{ matrix.file }}"
        $output = "D:\mingw.7z"
        $dest = "C:\mingw\${{ matrix.prefix }}"
        
        # 下载 (带重试)
        $attempt = 0
        do {
          $attempt++
          try {
            Write-Host "Downloading MinGW (attempt $attempt)..."
            curl.exe -L -o $output $mingwUrl --fail --silent --show-error --max-time 120
            if (Test-Path $output) { break }
          } catch {
            Write-Host "Download failed, retrying..."
            Start-Sleep -Seconds 5
          }
        } while ($attempt -lt 3)
        
        if (-not (Test-Path $output)) { throw "Download failed after 3 attempts" }
        
        # 解压
        & "C:\Program Files\7-Zip\7z.exe" x $output -o"$dest" -y
        
        # 添加到 PATH
        "$dest\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        Write-Host "MinGW installed to $dest"

    # 4. 验证 MinGW
    - name: Verify GCC
      shell: pwsh
      run: |
        gcc --version
        g++ --version
        mingw32-make --version

    # 5. 下载 mbedTLS 3.6.5
    - name: Get mbedTLS 3.6.5
      shell: pwsh
      run: |
        curl.exe -L -o "D:\mbedtls.zip" "https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/v3.6.5.zip" --fail --silent --show-error
        Expand-Archive -Path "D:\mbedtls.zip" -DestinationPath "C:\" -Force
        Rename-Item -Path "C:\mbedtls-3.6.5" -NewName "C:\mbedtls-src" -Force

    # 6. 构建 mbedTLS (使用 mingw32-make，避免 CMake 生成器问题)
    - name: Build mbedTLS
      shell: pwsh
      run: |
        cd C:\mbedtls-src
        New-Item -ItemType Directory -Force -Path "build"
        cd build
        
        # 使用 CMake 但指定生成器为 MinGW Makefiles
        cmake -G "MinGW Makefiles" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_C_COMPILER=gcc `
          -DENABLE_TESTING=OFF `
          -DENABLE_PROGRAMS=OFF `
          ..
        
        # 使用 mingw32-make 并行构建
        mingw32-make -j4
        
        Write-Host "mbedTLS build complete:"
        Get-ChildItem library\*.a

    # 7. 构建 Mongoose
    - name: Build Mongoose static lib
      shell: pwsh
      run: |
        $buildDir = "mongoose-src/build-${{ matrix.arch }}"
        New-Item -ItemType Directory -Force -Path $buildDir
        cd $buildDir
        
        $cflags = @(
          "-O3"
          "-DMG_ENABLE_IPV6=1"
          "-DMG_ENABLE_LINES=1"
          "-DMG_TLS=MG_TLS_MBED"
          "-static"
          "-I.."
          "-IC:\mbedtls-src\include"
        )
        
        # 编译
        gcc -c ($cflags -join " ") ..\mongoose.c -o mongoose.o
        
        # 打包静态库 (使用 MinGW 的 ar)
        ar rcs libmongoose.a mongoose.o
        ranlib libmongoose.a
        
        Write-Host "Build complete:"
        Get-ChildItem libmongoose.a

    # 8. 测试链接 (关键步骤：验证所有依赖)
    - name: Test linking
      shell: pwsh
      run: |
        $buildDir = "mongoose-src/build-${{ matrix.arch }}"
        cd $buildDir
        
        # 创建简单测试文件
        @'
        #include "mongoose.h"
        #include <stdio.h>
        int main() { 
          printf("Mongoose %s\n", MG_VERSION); 
          return 0; 
        }
        '@ | Set-Content "test.c" -Encoding ASCII
        
        # 链接测试 (严格按照顺序)
        gcc -static test.c `
          -I.. -IC:\mbedtls-src\include `
          -L. -lmongoose `
          -LC:\mbedtls-src\build\library -lmbedtls -lmbedx509 -lmbedcrypto `
          -lws2_32 -lbcrypt `
          -o test.exe
        
        if (Test-Path "test.exe") {
          Write-Host "✅ Linking successful!"
          & ".\test.exe"
        } else {
          throw "Linking failed"
        }

    # 9. 打包
    - name: Package
      shell: pwsh
      run: |
        $pkg = "mongoose-mbedtls-3.6.5-${{ matrix.arch }}"
        New-Item -ItemType Directory -Path "$pkg/lib", "$pkg/include/mbedtls", "$pkg/include/psa" -Force
        
        Copy-Item "mongoose-src/build-${{ matrix.arch }}/libmongoose.a" "$pkg/lib/"
        Copy-Item "mongoose-src/mongoose.h" "$pkg/include/"
        Copy-Item "C:\mbedtls-src\build\library\*.a" "$pkg/lib/"
        Copy-Item "C:\mbedtls-src\include\mbedtls\*.h" "$pkg\include\mbedtls\"
        Copy-Item "C:\mbedtls-src\include\psa\*.h" "$pkg\include\psa\" -ErrorAction SilentlyContinue
        
        # 创建简单 README
        "Link order: -lmongoose -lmbedtls -lmbedx509 -lmbedcrypto -lws2_32 -lbcrypt" | Out-File "$pkg\README.txt"
        
        # 压缩
        Compress-Archive -Path $pkg -DestinationPath "$pkg.zip"

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: mongoose-mbedtls-${{ matrix.arch }}
        path: mongoose-mbedtls-3.6.5-*.zip
