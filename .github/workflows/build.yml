name: Build Mongoose + mbedTLS 3.6.5 (MinGW GCC 9.3 SJLJ, TLS 1.3)

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (如: 7.20-3.6.5)'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-2019
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: i686
            mingw_file: winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            prefix: mingw32
          - arch: x86_64
            mingw_file: winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            prefix: mingw64

    steps:
    - uses: actions/checkout@v4

    - name: Install 7-Zip
      run: |
        choco install 7zip -y
        "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Append

    - name: Build All
      shell: pwsh
      run: |
        # 1. 下载 MinGW
        $mingwUrl = "https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/${{ matrix.mingw_file }}"
        $mingwArchive = "D:\mingw.7z"
        
        $attempt = 0
        do {
          $attempt++
          curl.exe -L -o $mingwArchive $mingwUrl --fail --silent --show-error --max-time 180
          if ($LASTEXITCODE -eq 0) { break }
          Start-Sleep -Seconds 5
        } while ($attempt -lt 3)
        
        if (-not (Test-Path $mingwArchive)) { throw "Failed to download MinGW" }
        
        Remove-Item -Recurse -Force -ErrorAction SilentlyContinue C:\mingw
        & "C:\Program Files\7-Zip\7z.exe" x $mingwArchive -o"C:\mingw" -y
        
        $mingwBin = "C:\mingw\${{ matrix.prefix }}\bin"
        if (-not (Test-Path "$mingwBin\gcc.exe")) { throw "gcc.exe not found" }
        
        $env:PATH = "$mingwBin;" + $env:PATH
        & "$mingwBin\gcc.exe" --version

        # 2. 下载源码
        git clone --depth 1 https://github.com/cesanta/mongoose.git mongoose-src
        git clone --recursive --depth 1 --branch v3.6.5 https://github.com/Mbed-TLS/mbedtls.git C:\mbedtls-src

        # 3. 构建 mbedTLS
        Write-Host ">>> Building mbedTLS..."
        Remove-Item -Recurse -Force -ErrorAction SilentlyContinue C:\mbedtls-install
        
        cmake -G "MinGW Makefiles" -S C:\mbedtls-src -B C:\mbedtls-src\build `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_C_COMPILER="$mingwBin\gcc.exe" `
          -DCMAKE_AR="$mingwBin\ar.exe" `
          -DCMAKE_RANLIB="$mingwBin\ranlib.exe" `
          -DCMAKE_INSTALL_PREFIX="C:\mbedtls-install" `
          -DENABLE_TESTING=OFF `
          -DENABLE_PROGRAMS=OFF `
          -DGEN_FILES=OFF
        
        cmake --build C:\mbedtls-src\build --parallel 4
        if ($LASTEXITCODE -ne 0) { throw "mbedTLS build failed" }
        
        cmake --install C:\mbedtls-src\build
        if ($LASTEXITCODE -ne 0) { throw "mbedTLS install failed" }
        
        Get-ChildItem "C:\mbedtls-install\lib\*.a"

        # 4. 构建 Mongoose
        Write-Host ">>> Building Mongoose..."
        New-Item -ItemType Directory -Force -Path "mongoose-src\build-${{ matrix.arch }}" | Out-Null
        Set-Location "mongoose-src\build-${{ matrix.arch }}"
        
        & "$mingwBin\gcc.exe" -c -O3 `
          -DMG_ENABLE_IPV6=1 -DMG_ENABLE_LINES=1 -DMG_TLS=MG_TLS_MBED -DNDEBUG `
          -I.. -I"C:\mbedtls-install\include" `
          -static "..\mongoose.c" -o mongoose.o
        if ($LASTEXITCODE -ne 0) { throw "Mongoose compile failed" }
        
        & "$mingwBin\ar.exe" rcs libmongoose.a mongoose.o
        & "$mingwBin\ranlib.exe" libmongoose.a

        # 5. 测试链接
        Write-Host ">>> Testing..."
        Set-Content -Path "test.c" -Value '#include "mongoose.h"' -Encoding ASCII
        Add-Content -Path "test.c" -Value '#include <stdio.h>' -Encoding ASCII
        Add-Content -Path "test.c" -Value 'int main(void) { printf("OK\n"); return 0; }' -Encoding ASCII
        
        & "$mingwBin\gcc.exe" -static test.c -I.. -I"C:\mbedtls-install\include" -L. -lmongoose -L"C:\mbedtls-install\lib" -lmbedtls -lmbedx509 -lmbedcrypto -lws2_32 -lbcrypt -o test.exe
        if (-not (Test-Path "test.exe")) { throw "Linking failed" }
        & ".\test.exe"

        # 6. 打包
        Write-Host ">>> Packaging..."
        $pkg = "mongoose-mbedtls365-${{ matrix.arch }}"
        New-Item -ItemType Directory -Path "$pkg\lib", "$pkg\include\mbedtls", "$pkg\include\psa" -Force | Out-Null
        Copy-Item "libmongoose.a" "$pkg\lib\"
        Copy-Item "..\mongoose.h" "$pkg\include\"
        Copy-Item "C:\mbedtls-install\lib\*.a" "$pkg\lib\"
        Copy-Item "C:\mbedtls-install\include\mbedtls\*.h" "$pkg\include\mbedtls\"
        Copy-Item "C:\mbedtls-install\include\psa\*.h" "$pkg\include\psa\" -ErrorAction SilentlyContinue
        "gcc app.c -I./include -L./lib -lmongoose -lmbedtls -lmbedx509 -lmbedcrypto -lws2_32 -lbcrypt -static" | Out-File "$pkg\README.txt"
        Compress-Archive -Path $pkg -DestinationPath "$env:GITHUB_WORKSPACE\mongoose-mbedtls365-${{ matrix.arch }}.zip" -Force
        Write-Host "Package created: mongoose-mbedtls365-${{ matrix.arch }}.zip"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: mongoose-mbedtls365-${{ matrix.arch }}
        path: mongoose-mbedtls365-*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    permissions:
      contents: write
    
    steps:
    # 关键修复：必须先检出代码才能打标签
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整git历史以便打标签
    
    - uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: artifacts
    
    # 手动触发时创建标签
    - name: Create Tag
      if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/')
      id: create_tag
      run: |
        # 获取输入的版本号并清理（去掉空格等非法字符）
        VERSION="${{ github.event.inputs.version }}"
        VERSION=$(echo "$VERSION" | tr -d ' ' | tr -d '"' | tr -d "'" | tr -d '/' | tr -d '\\')
        
        if [ -z "$VERSION" ]; then
          VERSION="build-$(date +%Y%m%d-%H%M%S)"
        else
          VERSION="v${VERSION}"
        fi
        
        echo "tag_name=$VERSION" >> $GITHUB_OUTPUT
        echo "Creating tag: $VERSION"
        
        # 配置Git用户信息（GitHub Actions必需）
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # 创建并推送轻量级标签
        git tag "$VERSION"
        git push origin "$VERSION"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 发布到Release
    - name: Release to GitHub
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*.zip
        tag_name: ${{ steps.create_tag.outputs.tag_name || github.ref_name }}
        name: Mongoose + mbedTLS (GCC 9.3 SJLJ) ${{ steps.create_tag.outputs.tag_name || github.ref_name }}
        body: |
          ## Mongoose + mbedTLS 静态库 (TLS 1.3)
          
          **编译环境**: MinGW-w64 GCC 9.3.0 SJLJ | **mbedTLS**: 3.6.5 LTS
          
          ### 包含文件
          - `libmongoose.a` - Mongoose库（启用mbedTLS后端）
          - `libmbedtls.a` - mbedTLS核心库
          - `libmbedx509.a` - X509证书库
          - `libmbedcrypto.a` - 加密算法库
          - 所有头文件（`mongoose.h`, `mbedtls/*.h`, `psa/*.h`）
          
          ### 使用方法
          ```bash
          gcc your_app.c -I./include -L./lib \
            -lmongoose -lmbedtls -lmbedx509 -lmbedcrypto \
            -lws2_32 -lbcrypt -static
          ```
          
          ### 下载
          - `mongoose-mbedtls365-i686.zip` - **32位** (x86)
          - `mongoose-mbedtls365-x86_64.zip` - **64位** (x64)
          
          ⚠️ **注意**: 必须使用 `-static` 链接，否则依赖 `libgcc_s_sjlj-1.dll`
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
