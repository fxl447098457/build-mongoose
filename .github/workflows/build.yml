name: Build Mongoose (Pragmatic)

on: [push, workflow_dispatch]

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x86_64, i686]
        build_type: [static, shared]
    steps:
      - name: Checkout Mongoose
        uses: actions/checkout@v4
        with:
          repository: cesanta/mongoose
          ref: 7.20

      - name: Checkout mbedTLS
        uses: actions/checkout@v4
        with:
          repository: Mbed-TLS/mbedtls
          ref: v3.6.5
          path: mbedtls
          submodules: recursive

      # === 使用你已验证的 MinGW 包 ===
      - name: Set MinGW URL
        id: mingw
        shell: bash
        run: |
          if [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            echo "URL=https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z" >> $GITHUB_OUTPUT
            echo "DIR=mingw64" >> $GITHUB_OUTPUT
          else
            echo "URL=https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z" >> $GITHUB_OUTPUT
            echo "DIR=mingw32" >> $GITHUB_OUTPUT
          fi

      - name: Download MinGW
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "${{ steps.mingw.outputs.URL }}" -OutFile mingw.7z

      - name: Extract MinGW
        run: 7z x mingw.7z -o${{ steps.mingw.outputs.DIR }}

      - name: Add to PATH
        run: |
          echo "${{ github.workspace }}/${{ steps.mingw.outputs.DIR }}/bin" >> $GITHUB_PATH

      # === 编译 mbedTLS ===
      - name: Build mbedTLS
        shell: bash
        run: |
          mkdir -p mbedtls/build && cd mbedtls/build
          cmake .. \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc
          cmake --build .

      # === 生成 CMakeLists.txt（简化版）===
      - name: Create CMakeLists.txt
        shell: bash
        run: |
          cat > CMakeLists.txt << 'EOF'
          cmake_minimum_required(VERSION 3.10)
          project(mongoose LANGUAGES C)
          add_library(mongoose mongoose.c)
          target_include_directories(mongoose PUBLIC .)
          if(DEFINED ENV{MBEDTLS_INCLUDE_DIR})
            target_include_directories(mongoose PRIVATE $ENV{MBEDTLS_INCLUDE_DIR})
            target_link_libraries(mongoose 
              $ENV{MBEDTLS_LIBRARY}
              $ENV{MBEDX509_LIBRARY}
              $ENV{MBEDCRYPTO_LIBRARY}
            )
            target_compile_definitions(mongoose PRIVATE MG_ENABLE_MBEDTLS=1)
          endif()
          if(BUILD_SHARED_LIBS)
            set_target_properties(mongoose PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS ON)
          endif()
          EOF

      # === 编译 Mongoose ===
      - name: Build Mongoose
        shell: bash
        env:
          MBEDTLS_INCLUDE_DIR: ${{ github.workspace }}/mbedtls/include
          MBEDTLS_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedtls.a
          MBEDX509_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedx509.a
          MBEDCRYPTO_LIBRARY: ${{ github.workspace }}/mbedtls/build/library/libmbedcrypto.a
        run: |
          mkdir -p build && cd build
          cmake .. \
            -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=gcc \
            -DBUILD_SHARED_LIBS=${{ matrix.build_type == 'shared' && 'ON' || 'OFF' }}
          cmake --build .

      # === 收集产物 ===
      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          cd build
          if [[ "${{ matrix.build_type }}" == "shared" ]]; then
            cp mongoose.dll ../artifacts/ 2>/dev/null || true
            cp libmongoose.dll.a ../artifacts/ 2>/dev/null || true
          else
            cp libmongoose.a ../artifacts/ 2>/dev/null || true
          fi
          cp ../mongoose.h ../artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongoose-${{ matrix.arch }}-${{ matrix.build_type }}-sjlj-tls
          path: artifacts/
